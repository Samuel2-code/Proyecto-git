<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extracción de Datos de PDF</title>
  <style>
    /* ... (mantén todos los estilos CSS que ya tienes) ... */
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>Extracción de Datos de PDF</h1>
    <form id="upload-form" enctype="multipart/form-data" novalidate>
      <label for="files">Selecciona archivos PDF</label>
      <input type="file" id="files" name="files[]" multiple accept=".pdf" required />
      <div style="text-align: center; margin-top: 1.25rem;">
        <button type="submit">Procesar Archivos</button>
      </div>
    </form>
    <div id="result" aria-live="polite" aria-atomic="true"></div>
  </div>

  <script>
    const form = document.getElementById('upload-form');
    const resultDiv = document.getElementById('result');

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const filesInput = form.files;
      if (!form.files || form.files.length === 0) {
        resultDiv.innerHTML =
          `<div class="alert alert-error">Por favor selecciona al menos un archivo PDF.</div>`;
        return;
      }

      resultDiv.innerHTML =
        `<div class="alert" style="background:#d1c4ff; color:#4b2ddb; font-weight:700;">Procesando archivos, por favor espera...</div>`;

      const formData = new FormData(form);

      fetch('/process', {
  method: 'POST',
  body: formData
})
  .then(response => {
    if (!response.ok || !response.headers.get("Content-Type").includes("spreadsheetml")) {
      return response.json().then(data => {
        throw new Error(data.message || 'Error procesando los archivos.');
      });
    }
    return response.blob();
  })
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'datos_pacientes.xlsx';
    document.body.appendChild(a);
    a.click();
    a.remove();
    resultDiv.innerHTML =
      `<div class="alert alert-success">✅ Datos procesados con éxito. El archivo Excel se ha descargado automáticamente.</div>`;
  })
  .catch(err => {
    resultDiv.innerHTML =
      `<div class="alert alert-error">⚠️ ${err.message}</div>`;
  });

    });
  </script>
</body>
</html>
